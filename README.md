# Reinforcement Portfolio Trader (EIIE)

본 문서는 산업별 재무·거시·ETF 지표를 결합하여 EIIE 구조의 강화학습 에이전트를 학습·평가하는 파이프라인을 정리한 내부 보고서입니다. 연구 배경보다는 “어떤 입력을 사용하고, 어떤 단계를 거쳐, 어떤 결과를 산출하는지”에 초점을 두었습니다.

---

## 저장소 구성
| 이름 | 역할 | 비고 |
| --- | --- | --- |
| `전처리.py` | 원천 엑셀 시트로부터 학습용 특징 행렬을 구축합니다. | 실행 스크립트 |
| `EIIE 강화학습.py` | FinRL 기반 EIIE + PPO를 이용해 학습 및 성과 평가를 수행합니다. | 실행 스크립트 |
| `requirements.txt` | 파이프라인 재현을 위한 파이썬 패키지 목록입니다. | `pip install -r requirements.txt` |
| `강화학습 기반 산업 포트폴리오 트레이딩 모델.pdf` | 실험 결과 요약 자료입니다. | 참고 자료 |

---

## 입력 데이터 규격
- 단일 엑셀 파일(예: `산업통합.xlsx`)에 다음 시트가 포함되어 있어야 합니다. 파일명과 시트명은 `전처리.py` 상단의 `pd.read_excel(..., sheet_name=...)` 인자와 일치해야 합니다.
  - `산업`: `Symbol Name`, `Item Name`, 월별 ETF 가격
  - `산업별시가총액`: `Symbol Name`, `Item Name`, 월별 시가총액
  - `산업별경제지표`: `Item Name`, 월별 거시경제 지표(금리, 환율, 원자재 등)
  - `ETF구성`: `Symbol Name`, ETF 메타데이터
- 공통 조건
  - 날짜는 Excel 기본 날짜 형식을 유지하며 `time` 컬럼(또는 열 헤더)에 위치합니다.
  - 종목명은 공백·특수문자 제거가 용이하도록 문자열로 제공해 주십시오. 스크립트에서 규칙화합니다.
  - 결측값/0 값은 허용됩니다. 전처리 단계에서 로그 변환·보간·파생 컬럼 분리로 보정합니다.

권장 인코딩 및 경로
- 윈도우 한글 경로 환경을 고려하여 파일 인코딩은 UTF-8을 권장합니다.
- 엑셀 파일은 프로젝트 루트에 배치하시고, 파일명·시트명을 코드와 일치시키는 것이 재현에 유리합니다.

---

## 전처리 파이프라인 상세 (`전처리.py`)
1. 시트 정리 및 통합
   - 불필요 열 제거, 산업명 규칙화(접두/특수문자 제거), `melt→pivot` 변환으로 `(Symbol Name, time)` 멀티 인덱스 구성
   - 재무제표 분기 공시 지연을 반영하여 발표분의 반영 시점을 월 단위로 이동
     - 1분기: 6월 첫 영업일, 2분기: 8월 첫 영업일, 3분기: 12월 두 번째 영업일, 4분기: 다음 해 4월 첫 영업일
2. 타임라인 확장 및 병합
   - 기준 구간: 2004-04-01 ~ 2025-01-31 (일 단위)
   - 종목별 forward-fill을 적용하여 분기·월 간 공백을 최소화합니다.
   - 산업·재무·거시 특징을 outer join으로 결합하여 단일 특징 행렬을 구성합니다.
3. 수치 변환/정규화
   - ETF 가격: 기준월 대비 1로 정규화합니다.
   - 재무/거시 변수: 로그 변환을 적용합니다. 음수는 파생 컬럼(예: `영업이익(-)`)에 절댓값 로그로 분리 저장합니다.
   - 0 이하는 0으로 유지하여 로그 변환의 수치 불안정을 방지합니다.
4. 리샘플링 및 피처 선택
   - 월초(`MS`) 리샘플링으로 월 단위 입력을 확보합니다.
   - 모델 입력에 사용하는 41개 핵심 피처만 선택하고 컬럼 순서를 고정합니다.
5. 전처리 산출물
   - `통합데이터.xlsx`: 통합 전처리 결과(품질 점검용)
   - `산업별통합데이터.xlsx`: 학습 스크립트가 사용하는 최종 입력 데이터
   - (`...1.xlsx`, `...2.xlsx`) 등 스냅샷: 기간/결측 조건별 점검 스냅샷

품질 점검 체크리스트
- 산업 수, 날짜 범위(2014-04-02 ~ 2025-01-31), 핵심 피처 포함 여부를 확인해 주십시오.
- 월 단위 시계열이 끊김 없이 이어지는지, forward-fill 구간이 과도하지 않은지 검토해 주십시오.

---

## 학습 파이프라인 상세 (`EIIE 강화학습.py`)
1. 데이터 로드 및 구간 분할
   - `산업별통합데이터.xlsx`를 로드하여 `time`을 datetime으로 변환합니다.
   - 학습: 2014-04-02 ~ 2021-03-31 / 평가: 2021-04-01 ~ 2025-01-31로 구분합니다.
   - 두 구간 모두 동일 종목 구성을 유지하도록 결측 종목을 제거합니다.
2. 환경 설정
   - `PortfolioOptimizationEnv` 기본 파라미터
     - 특징 수: 41, 윈도우: 15개월, 거래비용: 0.12%, 초기자본: 100,000, 보상 스케일링: 0.99995
   - CUDA 사용 가능 시 GPU가 자동 선택됩니다.
3. 모델 및 학습 설정
   - 모델: FinRL EIIE(1D Conv 기반·Shared Kernel), 출력층 Softmax(비중 합 1 보장)
   - 알고리즘: Stable-Baselines3 PPO (배치 128, 타임스텝 200×에피소드, GAE 사용)
   - 체크포인트/로깅은 필요에 따라 추가하실 수 있습니다.
4. 평가 및 지표 산출
   - 학습/평가 구간의 포트폴리오 가치와 종목 비중을 시계열로 기록합니다.
   - Buy & Hold(균등 비중)과 비교하여 Sharpe, Sortino, MDD, CAGR, Omega를 산출합니다.
   - QuantStats·Matplotlib을 활용한 후속 시각화가 가능합니다.

---

## 생성 파일(산출물)
| 파일 | 내용 |
| --- | --- |
| `train_portfolio_data.xlsx` | 학습 구간 포트폴리오 가치 시계열 |
| `test_portfolio_data.xlsx` | 평가 구간 포트폴리오 가치 시계열 |
| `weights_train.xlsx`, `weights_test.xlsx` | 기간별 자산 비중 행렬(파일명은 코드 설정에 따라 변동 가능) |
| 콘솔 로그 | Sharpe, Sortino, MDD, CAGR, Omega 등 성과 지표 |

---

## 실행 순서(재현 절차)
1. 의존성 설치: `pip install -r requirements.txt`
2. 데이터 배치: 원본 엑셀을 프로젝트 루트에 배치하고 파일명·시트명을 스크립트와 일치시킵니다.
3. 전처리 실행: `python "전처리.py"`
4. 학습/평가 실행: `python "EIIE 강화학습.py"`
5. 산출물 확인: 생성된 엑셀 및 로그를 기반으로 리포트/대시보드를 작성합니다.

---

## 환경·호환성 참고
- 인코딩: UTF-8 권장(윈도우 한글 경로 사용 시 `openpyxl`과 함께 안정적입니다).
- 엑셀 엔진: `openpyxl` 사용을 권장합니다. (`pip install openpyxl`)
- 줄바꿈: Git 경고(LF↔CRLF)가 발생할 수 있으나 기능에 영향은 없습니다.
- 하드웨어: GPU(CUDA) 사용 가능 시 자동 선택되며, CPU만으로도 재현 가능합니다.

---

입력 스키마 또는 피처 구성이 변경될 경우 `전처리.py`의 시트 로딩 구간과 특징 선택 목록만 조정하시면 동일 파이프라인을 재사용하실 수 있습니다. 필요 시 체크포인트 저장과 하이퍼파라미터 탐색(Optuna) 기능을 활성화하여 실험 폭을 확장하시는 것을 권장드립니다.