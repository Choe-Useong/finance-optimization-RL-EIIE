# Reinforcement Portfolio Trader (EIIE)

본 문서는 산업별 재무·거시·ETF 지표를 결합하여 EIIE 구조의 강화학습 에이전트를 학습·평가하는 코드베이스를 기술합니다. 코드 구조·데이터 흐름·핵심 파라미터와 내부 동작에 대한 설명을 중심으로 구성하였습니다.

---

## 폴더 구조
```
.
├─ 코드/
│  ├─ 전처리.py                # 원천 엑셀 → 특징 행렬 변환
│  └─ EIIE 강화학습.py         # 환경 구성, EIIE+PPO 학습 및 평가
├─ README.md
├─ requirements.txt
└─ 강화학습 기반 산업 포트폴리오 트레이딩 모델.pdf
```

주요 파이썬 스크립트는 `코드/` 디렉터리로 이동되었습니다. 경로 상의 공백·한글을 고려하여 파일 접근 시 UTF-8 인코딩과 `openpyxl` 엔진 사용을 권장드립니다.

---

## 입력 데이터 모델
- 단일 엑셀 파일(예: `산업통합.xlsx`) 내 시트 집합을 가정합니다. 파일명·시트명은 `코드/전처리.py` 상단의 `pd.read_excel(..., sheet_name=...)` 정의와 일치해야 합니다.
- 시트 요건 요약
  - `산업`: `Symbol Name`, `Item Name`, 월별 ETF 가격 시계열
  - `산업별시가총액`: `Symbol Name`, `Item Name`, 월별 시가총액 시계열
  - `산업별경제지표`: `Item Name`, 월별 거시 변수(금리·환율·원자재 등) 시계열
  - `ETF구성`: `Symbol Name`, ETF 메타데이터
- 공통 규칙
  - 날짜는 Excel 기본 날짜 형식. `time` 컬럼 기준 처리.
  - 종목명 정규화(접두/특수문자 제거, 한·영 통일)는 코드에서 수행합니다.
  - 결측/0 값 허용. 로그 변환·보간·파생 컬럼 분리로 보정합니다.

---

## 전처리 모듈(`코드/전처리.py`) 상세
- 역할: 원천 시트를 `(Symbol Name, time)` 멀티 인덱스 기반의 통합 특징 행렬로 생성합니다.
- 주요 처리 단계
  - 시트 단위 `melt → pivot` 변환으로 피처 열 정렬, 불필요 열 제거 및 명칭 규칙화
  - 재무제표 발표 지연 반영(1Q: 6월1영업일, 2Q: 8월1영업일, 3Q: 12월2영업일, 4Q: 다음해 4월1영업일)
  - 2004-04-01 ~ 2025-01-31 구간 일 단위 타임라인 확장 후 섹터별 forward-fill
  - 수치 변환: 가격은 기준월=1 정규화, 재무/거시는 로그 변환, 음수는 `지표명(-)`에 절댓값 로그 저장
  - 월초(`MS`) 리샘플링 및 41개 핵심 피처 선택(컬럼 순서 고정)
- 산출물
  - `통합데이터.xlsx`: 품질 점검용 전체 행렬
  - `산업별통합데이터.xlsx`: 학습 입력 전용 데이터
- 인코딩/엔진
  - `openpyxl` 엔진 사용 전제를 두고 UTF-8 경로 환경에서 안정적으로 동작하도록 작성되어 있습니다.

설계 상 전처리 단계는 사이드 이펙트 없이 입력 → 출력이 결정적이며, 동일한 스키마를 유지하는 한 재현성이 보장됩니다.

---

## 학습 모듈(`코드/EIIE 강화학습.py`) 상세
- 외부 의존: FinRL(`finrl`), Stable-Baselines3, QuantStats, PyTorch 등
- 환경(`PortfolioOptimizationEnv`) 파라미터
  - `features`: 41개 특징 컬럼 시퀀스
  - `time_window`: 15 (월 단위 롤링 윈도우)
  - `comission_fee_pct`: 0.0012 (거래 비용 0.12%)
  - `reward_scaling`: 0.99995 (로그 수익률 스케일링)
  - `initial_amount`: 100000 (초기 자본)
  - 디바이스: CUDA 사용 가능 시 GPU(`cuda:0`), 아니면 CPU
- 모델(EIIE)·알고리즘(PPO)
  - EIIE: 1D Conv shared 커널로 섹터별 시계열 표현 학습, Softmax로 비중 산출(합=1 보장)
  - PPO: 배치 128, 타임스텝 200×에피소드, GAE 기반 Advantage, 클리핑 등은 FinRL 기본값 준용
- 데이터 분할·검증
  - 학습: 2014-04-02 ~ 2021-03-31, 평가: 2021-04-01 ~ 2025-01-31
  - 학습/평가 동일 섹터 리스트 유지(결측 섹터 제외)
- 지표 산출(QuantStats)
  - Sharpe, Sortino, MDD, CAGR, Omega를 학습/평가 구간에 대해 계산
  - Buy & Hold(균등 비중) 대비 성과 비교용 시계열을 함께 생성
- 산출 파일
  - `train_portfolio_data.xlsx`, `test_portfolio_data.xlsx`: 구간별 포트폴리오 가치 시계열
  - `weights_train.xlsx`, `weights_test.xlsx`: 시점별 섹터 비중(코드 설정에 따라 파일명 달라질 수 있음)

학습 스크립트는 데이터 적재 → 환경 구성 → 학습 → 평가 → 지표 산출의 순서로 진행되며, 각 단계는 독립적인 함수/블록으로 나뉘어 유지보수가 용이하도록 구성되어 있습니다.

---

## 구성(Configurables) 요약
- 데이터
  - 입력 파일명·시트명: `코드/전처리.py` 상단 `pd.read_excel` 호출부에서 정의
  - 기간: 학습/평가 분할 기준 일자 문자열
- 환경
  - 수수료율, 보상 스케일링, 윈도우 길이, 초기 자본 등 하이퍼파라미터
- 모델/알고리즘
  - EIIE 채널 크기(공유 conv 채널 등), PPO 배치/스텝/클립 파라미터(기본값 준용)

변경은 코드 상단 상수 또는 초기화 인자만 수정하면 되도록 구성되어 있습니다.

---

## 호환성·로케일 주의사항
- 인코딩: UTF-8 권장(한글 경로/파일명 환경)
- 엑셀 엔진: `openpyxl` 권장
- 줄바꿈: CRLF/LF 혼용 경고는 기능에 영향이 없으며 저장소 정책에 맞춰 정리 가능합니다.

---

## 한계 및 가정
- 원천 데이터의 시트/컬럼 명칭이 변경될 경우 전처리 모듈의 로딩/정규화 규칙을 함께 조정하셔야 합니다.
- 41개 특징 선택은 현재 실험 기준이며, 피처 엔지니어링 변경 시 모델 입력 스키마를 함께 업데이트해야 합니다.

본 문서는 코드의 구조와 동작 원리를 빠르게 파악하실 수 있도록 작성되었습니다. 추가적인 클래스/함수 레벨 문서화가 필요하시면 특정 구간을 지정해 주십시오.
