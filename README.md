# Reinforcement Portfolio Trader (EIIE)

강화학습 기반 산업 포트폴리오 모델을 개발자 시점에서 재현할 수 있도록 코드 구조, 전처리 흐름, 학습 파이프라인, 산출물을 정리했습니다. 연구 배경보다 “어떤 입력을 넣고 어떤 단계를 거쳐 어떤 결과를 만든다”에 집중합니다.

---

## 1. 프로젝트 개요 & 파일 맵
| 파일 | 설명 | 실행 여부 |
| --- | --- | --- |
| `전처리.py` | 원본 엑셀(재무/거시/ETF)을 읽어 학습용 시계열(산업×월×피처)로 가공 | 직접 실행 |
| `EIIE 강화학습.py` | FinRL + Stable-Baselines3 기반 EIIE 정책 네트워크 학습 및 평가 | 직접 실행 |
| `requirements.txt` | 필요 파이썬 패키지 목록 | 가상환경 생성 후 `pip install -r` |
| `강화학습 기반 산업 포트폴리오 트레이딩 모델.pdf` | 전체 실험 리포트 (참고용) | 실행 X |

> 데이터 파일(.xlsx)은 `.gitignore` 처리되어 있으니 개인 데이터는 각자 관리하세요.

---

## 2. 데이터 파이프라인 (전처리.py 세부 단계)
1. **입력 준비**
   - 하나의 엑셀 파일(예: `dataset.xlsx`)에 다음 시트가 필요합니다.  
     `산업`, `업종별시가총액`, `경제지표`, `ETF정보` (시트명은 코드와 일치해야 합니다)
   - 필수 컬럼 예시  
     - 산업 시트: `Symbol Name`, `time`, `ETF 가격`, `시가총액`  
     - 재무제표 시트: `Symbol Name`, `time`, `총자산`, `총부채`, `매출액`, `영업이익`, `총포괄손익` 등  
     - 경제지표 시트: `Item Name`(금리/환율/원자재 구분), `time`, `Value`

2. **명칭 정리**
   - 산업 이름의 접두사 제거 (`IT - 정보기술` → `정보기술`)
   - 한글/영문 혼용명을 일관된 레이블로 통일
   - 공백과 특수문자 제거

3. **시트 단위 가공**
   - 모든 시트를 `melt → pivot` 변환하여 `(Symbol Name, time)` 인덱스에 피처 열이 붙은 형태로 재구성
   - 재무제표·경제지표처럼 다중 인덱스가 붙는 경우 `reset_index()` 후 `merge`를 반복

4. **시간 정렬 및 누락 보정**
   - 산업별로 시작~끝 날짜까지 일간 인덱스를 확장
   - 산업별로 forward-fill을 적용해 분기/월 정보 공백을 제거

5. **재무제표 시차 보정**
   - 분기 보고서 공개 지연을 반영해 데이터 반영 시점을 이동  
     | 분기 | 반영 시점 |
     | --- | --- |
     | 1분기 | 6월 첫 영업일 |
     | 2분기 | 8월 첫 영업일 |
     | 3분기 | 12월 두 번째 영업일 |
     | 4분기 | 다음 해 4월 첫 영업일 |
   - 이동된 날짜 기준으로 메인 테이블과 다시 `merge`

6. **피처 스케일링**
   - ETF 가격: 각 산업의 시작값으로 나눠 1에서 시작하도록 정규화
   - 재무/거시 지표: 로그 변환  
     - 0 이하 값은 0으로 유지  
     - 동시에 부호를 반전한 파생 컬럼(예: `영업이익(-)`)을 생성하고 양수인 값에만 로그 적용

7. **월간 샘플링**
   - `resample('MS')`로 월초 데이터만 선택 (EIIE 모델이 월 단위 입력을 기대)
   - 필요한 41개 피처만 추려 컬럼 순서를 고정

8. **산출물 저장**
   - `통합데이터.xlsx`: 전처리 전반을 확인할 수 있는 전체 테이블
   - `산업별통합데이터.xlsx`: 학습 스크립트에서 사용하는 최종 입력 파일

전처리가 끝난 뒤에는 산업 수, 날짜 범위(2014-04-02 ~ 2025-01-31), 주요 피처가 모두 포함돼 있는지, 월별 시계열이 끊김 없이 이어지는지 확인하세요.

---

## 3. 학습 파이프라인 (EIIE 강화학습.py 세부 단계)
1. **데이터 로드 및 분할**
   - `산업별통합데이터.xlsx`를 읽어서 학습/테스트 구간으로 분할  
     - Train: 2014-04-02 ~ 2021-03-31  
     - Test: 2021-04-01 ~ 2025-01-31
   - 두 구간에 동일한 산업 리스트가 있는지 확인하고 누락 산업이 있으면 제외

2. **환경 구성**
   - `PortfolioOptimizationEnv`에 아래 인자를 전달  
     - `features`: 41개 피처 리스트  
     - `time_window=15`: 15개월 롤링 윈도우  
     - `comission_fee_pct=0.0012`: 거래비용 0.12%  
     - `reward_scaling=0.99995`: 로그 수익률 스케일링  
     - `initial_amount=100000`: 초기 자본  
   - 테스트 환경도 동일 설정으로 생성

3. **EIIE 네트워크**
   - FinRL 제공 `EIIE` 클래스를 그대로 사용  
     - Shared Conv1d로 모든 산업에 같은 커널 적용  
     - 중간 채널 30, 최종 채널 20으로 Feature Fusion  
     - Softmax로 출력 비중을 만들고 합계 1을 자동 보장

4. **PPO 학습**
   - `DRLAgent` 래퍼로 Stable-Baselines3 PPO 모델 초기화  
     - 배치 크기 128, 에피소드 200 (월별 스텝 × 200)  
     - Advantage 계산은 GAE, 클리핑 계수 등은 FinRL 기본값 사용  
   - 필요하면 체크포인트 저장 코드를 추가해 반복 실행 시 재사용

5. **전략 평가**
   - 학습 완료 모델을 테스트 환경에 넣어 월별 포트폴리오 가치를 기록
   - 동일 기간에 Buy & Hold 전략(섹터 균등 비중)을 시뮬레이션하여 비교
   - 결과를 Pandas DataFrame으로 정리하고 엑셀 파일로 저장

6. **로그 및 지표 확인**
   - 콘솔에 Sharpe, Sortino, MDD, Omega, 누적 수익률, 연평균 성장률이 출력
   - 추가 리포트가 필요하면 QuantStats나 Matplotlib 플롯을 붙여 후처리 가능

실행 예시:
```powershell
python "EIIE 강화학습.py"
```
학습 시 CUDA가 가능한 환경이면 자동으로 GPU를 사용합니다.

---

## 4. 학습/평가 산출물
| 산출물 | 내용 |
| --- | --- |
| `train_portfolio_data.xlsx` | 학습 구간(2014-04 ~ 2021-03) 월별 누적 자산 가치 |
| `test_portfolio_data.xlsx` | 테스트 구간(2021-04 ~ 2025-01) 월별 누적 자산 가치 |
| `weights_train.xlsx`, `weights_test.xlsx` (또는 유사 이름) | 시점별 섹터 비중 테이블 |
| 콘솔 로그 | 학습 진행 상황 및 최종 성과 지표 |

보고서 기준 주요 결과:
- 학습 구간: 누적 수익률 2.244, Sharpe 0.488, MDD -0.535로 Buy & Hold 대비 전반적으로 우위
- 테스트 구간: 누적 수익률 1.171, Sharpe 0.162, MDD -0.175로 약세장 구간에서도 손실 폭을 줄이면서 수익을 방어

엑셀 출력은 Tableau, Power BI, 주피터 노트북 등으로 쉽게 시각화할 수 있으니 상황에 맞춰 활용하면 됩니다.

---
이 문서 순서대로 전처리 → 학습 → 평가를 진행하면 PDF에 정리된 실험을 동일하게 재현할 수 있습니다. 추가 질문이나 개선 아이디어는 GitHub 이슈로 남겨 주세요. 😄
