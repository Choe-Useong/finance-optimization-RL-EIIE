# Reinforcement Portfolio Trader (EIIE)

산업별 재무·거시·ETF 지표를 결합해 EIIE 구조의 강화학습 에이전트를 학습시키는 파이프라인을 정리한 내부 보고서다. 분석의 초점은 어떤 데이터를 투입하고, 어떤 절차를 밟으며, 어떤 결과물이 도출되는지에 맞춰져 있다.

---

## 주요 파일 현황
| 이름 | 역할 | 비고 |
| --- | --- | --- |
| `전처리.py` | 원천 엑셀 시트로부터 학습용 특징 행렬을 구축 | 실행 스크립트 |
| `EIIE 강화학습.py` | FinRL 기반 EIIE + PPO 학습 및 성과 평가 | 실행 스크립트 |
| `requirements.txt` | 파이프라인 재현에 필요한 파이썬 패키지 | `pip install -r requirements.txt` |
| `강화학습 기반 산업 포트폴리오 트레이딩 모델.pdf` | 실험 결과 요약 문서 | 참고 자료 |

---

## 입력 데이터 구조
- 단일 엑셀 파일(예: `산업통합.xlsx`)에 다음 시트가 포함되어 있다고 가정하였다. 파일명과 시트명은 `전처리.py` 상단의 `pd.read_excel` 인자와 일치해야 한다.
  - `산업`: `Symbol Name`, `Item Name`, 월별 ETF 가격
  - `산업별시가총액`: `Symbol Name`, `Item Name`, 월별 시가총액
  - `산업별경제지표`: `Item Name`, 월별 거시경제 지표 (금리, 환율, 원자재 등)
  - `ETF구성`: `Symbol Name`, ETF 메타데이터
- 공통 요건
  - 날짜 정보는 Excel 기본 날짜 형식으로 기록되어 있으며 `time` 컬럼 또는 헤더에 위치한다.
  - 종목명은 공백·특수문자 제거가 가능하도록 문자열 형태를 유지한다.
  - 결측값이나 0은 허용되며, 전처리 단계에서 로그 변환과 보간을 통해 보정된다.

---

## 전처리 파이프라인 (`전처리.py`)
1. **시트 정리 및 통합**  
   불필요한 열을 제거하고 종목명을 규칙화한 뒤 `melt→pivot` 변환으로 `(Symbol Name, time)` 멀티 인덱스를 구성하였다. 재무제표는 공시 지연을 반영해 분기별 발표 시점을 월 단위로 이동시켰다.
2. **타임라인 확장과 병합**  
   2004-04-01 ~ 2025-01-31 범위의 일 단위 타임라인을 구축하고 종목별 forward-fill을 적용해 연속 시계열을 확보하였다. 산업·재무·거시 데이터를 outer join으로 결합해 단일 특징 행렬로 정리하였다.
3. **수치 변환과 리샘플링**  
   ETF 가격은 기준월 대비 1로 정규화하고, 재무·거시 변수는 로그 변환을 적용하였다. 음수 값은 별도 컬럼(`지표명(-)`)으로 분리해 절댓값 로그를 저장하였다. 이후 월초(`MS`) 리샘플링을 거쳐 최종 41개 특징 컬럼을 유지하였다.
4. **산출물**  
   전처리 결과는 `통합데이터.xlsx`에 저장되며, 학습 입력 전용 데이터는 `산업별통합데이터.xlsx`로 분리된다. 기간·결측 조건 점검을 위한 스냅샷(`...1.xlsx`, `...2.xlsx`)도 동시에 생성된다.

---

## 학습 파이프라인 (`EIIE 강화학습.py`)
1. **데이터 로드 및 구간 분할**  
   `산업별통합데이터.xlsx`에서 `time`을 datetime으로 변환한 뒤 2014-04-02 ~ 2021-03-31 구간을 학습용, 2021-04-01 ~ 2025-01-31 구간을 평가용으로 구분하였다. 두 구간 모두 동일 종목 구성을 유지하도록 결측 종목을 제외하였다.
2. **환경 설정**  
   `PortfolioOptimizationEnv`에는 41개 특징, 15개월 롤링 윈도우, 거래 비용 0.12%, 초기 자본 100,000, 보상 스케일링 0.99995가 적용되었다. CUDA 사용 가능 시 GPU가 자동 선택된다.
3. **EIIE 모델 및 PPO 학습**  
   FinRL의 EIIE 1D 컨볼루션 네트워크로 종목별 표현을 생성하고 Softmax 출력으로 비중을 산출하였다. Stable-Baselines3 PPO는 배치 크기 128, 타임스텝 200×에피소드 설정으로 학습되었고, GAE 기반 Advantage 추정이 사용되었다.
4. **성과 산출**  
   학습·평가 구간의 포트폴리오 가치와 종목별 비중을 시계열로 저장하고, Buy & Hold(균등 비중)과 Sharpe, Sortino, MDD, CAGR, Omega 지표를 비교하였다. QuantStats·Matplotlib 기반 시각화는 선택적으로 호출 가능하다.

---

## 생성 산출물
| 파일 | 내용 |
| --- | --- |
| `train_portfolio_data.xlsx` | 학습 구간 포트폴리오 가치 시계열 |
| `test_portfolio_data.xlsx` | 평가 구간 포트폴리오 가치 시계열 |
| `weights_train.xlsx`, `weights_test.xlsx` *(코드 설정에 따라 파일명 변동 가능)* | 기간별 자산 비중 행렬 |
| 콘솔 로그 | Sharpe, Sortino, MDD, CAGR, Omega 등 성과 지표 |

---

## 실험 수행 개요
- 의존 패키지는 `pip install -r requirements.txt`로 설치한다.
- 전처리 단계는 `python "전처리.py"`, 학습 단계는 `python "EIIE 강화학습.py"` 실행으로 진행된다.
- 전처리 결과 검증과 학습 로그 점검 후, 산출된 엑셀과 지표를 기반으로 후속 리포트나 대시보드를 작성한다.

---

입력 구조나 피처 구성이 변하면 `전처리.py`의 시트 로딩 구간과 특징 목록만 조정해 동일 파이프라인을 재사용할 수 있다. 향후에는 체크포인트 저장, 하이퍼파라미터 탐색(Optuna) 등을 활성화해 실험 범위를 확장할 예정이다.
